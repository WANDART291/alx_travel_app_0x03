#!/bin/bash

echo "=== Task 5: Rolling Updates ==="

# First, make sure we're using blue deployment
echo "í´µ Ensuring we're using blue deployment for rolling update..."
kubectl patch service main-django-service -p '{"spec":{"selector":{"version":"blue"}}}'

sleep 5

# Set up port forwarding for testing
echo "í´— Setting up port forwarding..."
kubectl port-forward service/main-django-service 8080:80 &
PORT_FORWARD_PID=$!
sleep 10

# Start continuous health checks in background
echo "í¿¥ Starting continuous health checks..."
for i in {1..20}; do
    response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 2>/dev/null || echo "000")
    if [ "$response" = "200" ]; then
        echo "âœ… Health check $i: HTTP $response - Service is healthy"
    else
        echo "âš ï¸  Health check $i: HTTP $response - Service may be experiencing issues"
    fi
    sleep 2
done &
HEALTH_CHECK_PID=$!

# Apply the updated deployment (simulate update by changing environment variable)
echo "í´„ Applying updated deployment..."
kubectl set env deployment/messaging-app-deployment APP_VERSION="v2.0" UPDATED_AT="$(date +%Y%m%d%H%M%S)"

# Monitor the rolling update
echo "í³Š Monitoring rolling update progress..."
kubectl rollout status deployment/messaging-app-deployment --timeout=300s

if [ $? -eq 0 ]; then
    echo "âœ… Rolling update completed successfully!"
else
    echo "âŒ Rolling update failed or timed out!"
    kill $PORT_FORWARD_PID $HEALTH_CHECK_PID 2>/dev/null
    exit 1
fi

# Stop health checks
kill $HEALTH_CHECK_PID 2>/dev/null

# Verify the update is complete
echo "í´ Verifying current pods:"
kubectl get pods -l app=django-messaging,version=blue

echo "í³ Checking deployment status:"
kubectl describe deployment messaging-app-deployment | grep -A3 "Environment"

# Clean up
kill $PORT_FORWARD_PID 2>/dev/null

echo "í¾‰ Rolling update verification completed!"
