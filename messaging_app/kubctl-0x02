#!/bin/bash

echo "=== Task 4: Blue-Green Deployment ==="

# Deploy blue version
echo "í´µ Deploying blue version..."
kubectl apply -f blue_deployment.yaml

# Deploy green version
echo "í¿¢ Deploying green version..."
kubectl apply -f green_deployment.yaml

# Apply the main service
echo "í´— Applying main service..."
kubectl apply -f kubeservice.yaml

# Wait for both deployments to be ready
echo "â³ Waiting for deployments to be ready..."
kubectl wait --for=condition=available deployment/messaging-app-deployment --timeout=180s
kubectl wait --for=condition=available deployment/messaging-app-deployment-green --timeout=180s

# Check pods status
echo "í³‹ Current pods status:"
kubectl get pods -l app=django-messaging

# Check logs for errors in green deployment
echo "í³ Checking logs for green deployment:"
kubectl logs -l app=django-messaging,version=green --tail=5

# Show current service selector
echo "í´ Current service selector (before switch):"
kubectl get service main-django-service -o jsonpath='{.spec.selector}'
echo ""

# Switch traffic to green version
echo "í´„ Switching traffic to green version..."
kubectl patch service main-django-service -p '{"spec":{"selector":{"version":"green"}}}'

# Verify the switch
echo "í´ Current service selector (after switch):"
kubectl get service main-django-service -o jsonpath='{.spec.selector}'
echo ""

# Test the service
echo "í·ª Testing the service..."
kubectl port-forward service/main-django-service 8080:80 &
PORT_FORWARD_PID=$!
sleep 5

if curl -s http://localhost:8080 | grep -q "It works"; then
    echo "âœ… Green deployment is serving traffic (Apache)"
else
    echo "â“ Service response indicates it might still be serving from blue deployment"
fi

kill $PORT_FORWARD_PID 2>/dev/null

echo "âœ… Blue-green deployment completed!"
